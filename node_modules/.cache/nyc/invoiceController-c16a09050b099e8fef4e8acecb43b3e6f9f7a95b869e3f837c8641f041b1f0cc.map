{"version":3,"file":"/Users/yusramahomed/Desktop/SENG2021/se2021-23t1-einvoicing-api-h10a_CHEESECAKE-storage-api/src/controllers/invoiceController.ts","sources":["/Users/yusramahomed/Desktop/SENG2021/se2021-23t1-einvoicing-api-h10a_CHEESECAKE-storage-api/src/controllers/invoiceController.ts"],"names":[],"mappings":"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","sourcesContent":["import { Response, Request } from \"express\";\n//import { RequestInvoice } from \"../models/invoice\";\nimport { deleteInvoice, showInvoice, showRangeInvoice, storeInvoice } from \"../functions/invoice\";\nimport { db } from \"../config/firebase\";\nimport HTTPError from \"http-errors\";\nconst parseString = require('xml2js').parseString;\nimport jwt from \"jsonwebtoken\";\n\n\nasync function authenticateFromDB(token: string) {\n  // connect to db\n  const data = await db.collection(\"users\").get();\n\n  try {\n    console.log(\"HELLOOOO\");\n    const decodedToken = jwt.verify(token, \"cheesecake\") as jwt.JwtPayload;\n    // iterate over users\n    // if (!user) {\n    //   throw HTTPError(400, \"Invalid token.\");\n    // }\n\n    // return a user id\n    return decodedToken.userId;\n  } catch {\n    throw HTTPError(403, \"Invalid token.\");\n  }\n}\n\n\nexport const invoiceStore = async (req: Request, res: Response) => {\n  const token = req.headers.token as string;\n  const userId = await authenticateFromDB(token);\n  const invoiceXML = req.body;\n  const jsonInvoice = parseString(invoiceXML, (error, jsonData) => {\n    if (error) {\n      console.error('Error parsing XML:', error);\n    }\n  });\n  try {\n    const result = await storeInvoice(\n      userId,\n      JSON.stringify(jsonInvoice)\n    );\n    res.json(result)\n  } catch (error) {\n    res.status(error.statusCode || 500).json({ message: error.message });\n  }\n}\n\nexport const invoiceShow = async (req: Request, res: Response) => {\n  const token = req.headers.token as string;\n  const invoiceId = req.query.invoiceId as string;\n  const userId = await authenticateFromDB(token);\n  try {\n    const result = await showInvoice(\n      userId,\n      invoiceId\n    );\n    res.set('Content-Type', 'application/xml');\n    res.json(result)\n  } catch (error) {\n    res.status(error.statusCode || 500).json({ message: error.message });\n  }\n}\n\nexport const invoiceShowRange = async (req: Request, res: Response) => {\n  const token = req.headers.token as string;\n  const startDate = +req.query.startDate as number; \n  const endDate = +req.query.endDate as number;\n  const userId = await authenticateFromDB(token);\n  try {\n    const result = await showRangeInvoice(\n      userId,\n      startDate,\n      endDate\n    );\n    res.json(result)\n  } catch (error) {\n    res.status(error.statusCode || 500).json({ message: error.message });\n  }\n  \n}\n\nexport const invoiceDelete = async (req: Request, res: Response) => {\n  const token = req.headers.token as string;\n  const invoiceId = req.query.invoiceId as string;\n  const userId = await authenticateFromDB(token);\n  try {\n    const result = await deleteInvoice(\n      userId,\n      invoiceId\n    );\n    res.json(result)\n  } catch (error) {\n    res.status(error.statusCode || 500).json({ message: error.message });\n  }\n}"]}